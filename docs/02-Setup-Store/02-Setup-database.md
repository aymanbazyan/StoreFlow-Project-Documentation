# Database Setup Guide

This guide details the steps required to set up the PostgreSQL database and initialize the application schema, including the critical, high-performance full-text search functionality.

### 1. Setup PostgreSQL Server (First-Time Setup)

This section covers the initial installation and configuration of the PostgreSQL server. You only need to do this once per machine.

1.  **Install PostgreSQL.**

    ```bash
    sudo apt update
    sudo apt install postgresql postgresql-contrib
    sudo service postgresql start
    ```

2.  **Open the `psql` shell as the superuser.**

    ```bash
    sudo -u postgres psql
    ```

3.  **Create your application database.** (Replace `<your_database_name>`)

    ```sql
    CREATE DATABASE <your_database_name>;
    ```

4.  **Create a dedicated user for your application.** (Replace `<your_username>` and `<your_password>`)

    ```sql
    CREATE USER <your_username> WITH ENCRYPTED PASSWORD '<your_password>';
    ```

5.  **Grant privileges to the new user.**

    ```sql
    GRANT ALL PRIVILEGES ON DATABASE <your_database_name> TO <your_username>;
    ALTER USER <your_username> CREATEDB;
    ```

    After these commands, type `\q` to exit the `psql` prompt.

### 2. Configure the Application

1.  **Configure Environment Variables.**
    Your application connects to the database using the `DATABASE_URL`. Create a `.env` file in the project root and add the following line, replacing the placeholders with the credentials from Step 1.

    ```ini
    # .env
    DATABASE_URL="postgresql://<your_username>:<your_password>@localhost:5432/<your_database_name>?schema=public"
    ```

### 3. Initialize Schema & Manually Add Full-Text Search

The application's search feature relies on advanced PostgreSQL functions that **cannot be automatically generated by Prisma**. You must manually add custom SQL to a migration file.

1.  **Generate a new, empty migration file.**
    This command creates the file without applying it to the database yet.

    ```bash
    npm run prisma:migrate:dev
    ```

    Prisma will prompt for a name. Call it something descriptive like `add_full_text_search`. This will create a new directory inside `prisma/migrations/` containing an empty `migration.sql` file.

2.  **Add Custom SQL to the Migration File.**
    Open the newly created `migration.sql` file (e.g., `prisma/migrations/xxxxxxxx_add_full_text_search/migration.sql`). **Paste the entire SQL block below into this file.** This script performs five critical actions:

    - Adds a `search_vector` column.
    - Creates a function to populate that column.
    - Creates a trigger to automate the function.
    - **Creates a GIN index for high-speed searching.**
    - Updates all existing products to make them searchable.

    ```sql
    -- Add the search_vector column to the Products table
    ALTER TABLE "Products" ADD COLUMN "search_vector" tsvector;

    -- Create a function to update the search_vector column with both English and Arabic configurations
    CREATE OR REPLACE FUNCTION update_products_search_vector()
    RETURNS TRIGGER AS $$
    BEGIN
        NEW.search_vector :=
            to_tsvector('english', coalesce(NEW.name, '') || ' ' || coalesce(NEW.slug, '')) ||
            to_tsvector('arabic', coalesce(NEW.name, '') || ' ' || coalesce(NEW.slug, ''));
        RETURN NEW;
    END;
    $$ LANGUAGE plpgsql;

    -- Create a trigger that automatically updates the search_vector on any insert or update
    CREATE TRIGGER products_search_vector_update
    BEFORE INSERT OR UPDATE ON "Products"
    FOR EACH ROW EXECUTE FUNCTION update_products_search_vector();

    -- CRITICAL: Create a GIN index on the search_vector column for high-performance searching
    CREATE INDEX products_search_vector_idx ON "Products" USING gin(search_vector);

    -- IMPORTANT: Populate the search_vector for any existing data in the table
    -- This ensures that products created before this migration are still searchable
    UPDATE "Products" SET search_vector = to_tsvector('english', name || ' ' || slug) || to_tsvector('arabic', name || ' ' || slug);
    ```

3.  **Apply All Migrations.**
    Now, run the migrate command again. This will apply all pending migrations, including Prisma's schema and the custom raw SQL you just added.

    ```bash
    npm run prisma:migrate:dev
    ```

### 4. Verify the Setup (Mandatory)

After migrating, you **must** verify that the custom database objects were created correctly. An incomplete setup will lead to severe performance issues.

1.  **Connect to your database.**

    ```bash
    psql -U <your_username> -d <your_database_name> -h localhost
    ```

2.  **Inspect the `Products` table structure.**

    ```sql
    \d "Products"
    ```

3.  **Confirm the output.**
    Carefully check the "Indexes" and "Triggers" sections of the output. A successful setup **must** include both the GIN index and the trigger, as shown below:

    ```
                                        Table "public.Products"
        Column        |            Type             | Collation | Nullable |              Default
    --------------------+-----------------------------+-----------+----------+-----------------------------------
     ... (other columns) ...
     search_vector      | tsvector                    |           |          |

    Indexes:
        "Products_pkey" PRIMARY KEY, btree (slug)
        ... (other btree indexes) ...
        "products_search_vector_idx" gin (search_vector)  <-- ✅ THIS MUST BE PRESENT FOR FAST SEARCH

    Triggers:
        products_search_vector_update BEFORE INSERT OR UPDATE ON "Products" FOR EACH ROW EXECUTE FUNCTION update_products_search_vector()  <-- ✅ THIS MUST BE PRESENT

    ```

**Troubleshooting:** If either the `products_search_vector_idx` or the `products_search_vector_update` trigger is missing, it means the custom SQL was not applied correctly. Check your migration file for typos, or create a new migration specifically to add the missing pieces (`CREATE INDEX` or `CREATE TRIGGER`).

---

_Last updated on August 24, 2025 by Ayman._
